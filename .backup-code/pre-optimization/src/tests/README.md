# 博客应用测试指南

本目录包含博客应用的各种测试文件，用于确保应用的各个模块正常工作。

## 测试环境设置

项目使用 Vitest 作为测试框架。在运行测试前，请确保已安装所有依赖：

```bash
npm install
```

## 运行测试

运行所有测试：

```bash
npm test
```

以监视模式运行测试（开发时使用）：

```bash
npm run test:watch
```

生成测试覆盖率报告：

```bash
npm run test:coverage
```

## 测试文件组织

测试文件按照被测试的模块进行组织：

- `git-service.test.ts` - 测试 Git 服务功能，包括仓库操作
- `db.test.ts` - 测试数据库操作，包括文章的增删改查
- `sync-service.test.ts` - 测试同步功能，包括主键冲突处理

## 主键约束错误问题

在实际应用中，我们发现同步过程中会出现以下主键约束错误：

```
SqliteError: UNIQUE constraint failed: slug_mapping.slug
```

这通常发生在尝试将GitHub或本地文件系统中的文章同步到数据库时，slug变体已存在于数据库中。测试文件`sync-service.test.ts`专门包含了处理这种冲突的测试用例。

## 模拟依赖

在测试中，我们使用Vitest的模拟功能来模拟外部依赖，例如：

- GitHub API 调用
- 文件系统操作
- 远程Git操作

这样可以避免测试对外部资源的依赖，使测试更加可靠和快速。

## 添加新测试

添加新测试时，请遵循以下原则：

1. 为每个独立功能创建单独的测试文件
2. 使用描述性的测试名称
3. 测试前设置和测试后清理
4. 尽可能模拟外部依赖
5. 关注测试边界条件和错误处理 